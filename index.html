<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Light Bulb + Teachable Machine</title>
<link id="theme" rel="stylesheet" href="light-off.css" />
</head>
<body>

<div class="container">
  <div class="bulb" onclick="toggleLight()"></div>
  <p>Click the bulb to toggle, or say <strong>on/off</strong></p>

  <div>
    <button onclick="init()">ðŸŽ¤ Start Listening</button>
  </div>
  <div id="label-container"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/speech-commands@0.4.0/dist/speech-commands.min.js"></script>

<script>
const URL = "http://127.0.0.1:5500/my_model/";

function toggleLight(force) {
  const themeLink = document.getElementById('theme');
  const href = themeLink.getAttribute('href');

  if (force === 'on') {
    themeLink.setAttribute('href', 'light-on.css');
  } else if (force === 'off') {
    themeLink.setAttribute('href', 'light-off.css');
  } else {
    themeLink.setAttribute('href', href === 'light-off.css' ? 'light-on.css' : 'light-off.css');
  }
}

// --- Teachable Machine Imp.
async function createModel() {
  const checkpointURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";

  const recognizer = speechCommands.create(
    "BROWSER_FFT",
    undefined,
    checkpointURL,
    metadataURL
  );

  await recognizer.ensureModelLoaded();
  return recognizer;
}

async function init() {
  console.log("init() called");

  const recognizer = await createModel();
  console.log("Model loaded");

  const classLabels = recognizer.wordLabels();
  const labelContainer = document.getElementById("label-container");
  labelContainer.innerHTML = "";

  for (let i = 0; i < classLabels.length; i++) {
    labelContainer.appendChild(document.createElement("div"));
  }

  recognizer.listen(result => {
    const scores = result.scores;

    for (let i = 0; i < classLabels.length; i++) {
      labelContainer.childNodes[i].innerHTML = classLabels[i] + ": " + scores[i].toFixed(2);
    }

    const maxScore = Math.max(...scores);
    const maxIndex = scores.indexOf(maxScore);

    if (maxScore > 0.75) {
      const detected = classLabels[maxIndex].toLowerCase();
      console.log("Detected:", detected);

      if (detected.includes("on")) {
        toggleLight('on');
      } else if (detected.includes("off")) {
        toggleLight('off');
      }
    }
  }, {
    includeSpectrogram: false,
    probabilityThreshold: 0.75,
    invokeCallbackOnNoiseAndUnknown: false,
    overlapFactor: 0.5
  });
}
</script>

</body>
</html>
