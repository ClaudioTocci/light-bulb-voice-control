<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Light Bulb + Teachable Machine</title>
<link id="theme" rel="stylesheet" href="light-off.css" />
<style>
  .container { text-align: center; margin-top: 40px; }
  .bulb { width: 150px; height: 150px; margin: 0 auto 20px; background-size: cover; cursor: pointer; }
</style>
</head>
<body>

<div class="container">
  <div class="bulb" onclick="toggleLight()"></div>
  <p>Click the bulb or say: <strong>on</strong> / <strong>off</strong></p>

  <button onclick="init()">ðŸŽ¤ Start Listening</button>

  <div id="label-container"></div>
</div>

<!-- Correct libraries for Teachable Machine AUDIO -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/@teachablemachine/sound@latest"></script>

<script>
// CORRECT MODEL PATH FOR GITHUB PAGES
const URL = "./my_model/";

let model, maxPredictions, labelContainer;

// Toggle bulb on/off
function toggleLight(force) {
  const theme = document.getElementById("theme");
  const current = theme.getAttribute("href");

  if (force === "on") {
    theme.setAttribute("href", "light-on.css");
  } else if (force === "off") {
    theme.setAttribute("href", "light-off.css");
  } else {
    theme.setAttribute("href", current === "light-off.css" ? "light-on.css" : "light-off.css");
  }
}

async function init() {
  console.log("Loading model...");

  const modelURL = URL + "model.json";
  const metadataURL = URL + "metadata.json";

  model = await tmSound.load(modelURL, metadataURL);
  maxPredictions = model.getClassLabels().length;

  console.log("Model loaded!");

  // Prepare label container
  labelContainer = document.getElementById("label-container");
  labelContainer.innerHTML = "";
  for (let i = 0; i < maxPredictions; i++) {
    labelContainer.appendChild(document.createElement("div"));
  }

  listen();
}

function listen() {
  model.listen(result => {
    let highestProb = 0;
    let highestIndex = 0;

    // Display prediction scores
    for (let i = 0; i < maxPredictions; i++) {
      const score = result.scores[i];
      labelContainer.childNodes[i].innerHTML =
        model.getClassLabels()[i] + ": " + score.toFixed(2);

      if (score > highestProb) {
        highestProb = score;
        highestIndex = i;
      }
    }

    // Detect on/off
    if (highestProb > 0.75) {
      const detected = model.getClassLabels()[highestIndex].toLowerCase();
      console.log("Detected:", detected);

      if (detected.includes("on")) toggleLight("on");
      if (detected.includes("off")) toggleLight("off");
    }
  });
}
</script>

</body>
</html>
